<!DOCTYPE html>
<html>
<head>
  <title>WhiteRabbit3D Basic Test</title>
  <link rel="shortcut icon" href="images/wr3d.png" />
  <style>
    .canvas-container {
      width: 700px;
      height: 500px;
      margin: 40px auto 0px auto;
      background-color: gray;
    }

    .canvas-3d {
      width: 700px;
      height: 700px;
    }
    .canvas-2d {
      display: block;
      position:fixed;
      top:0px;
      left:0px;
    }
  </style>

  <script id="flat-vertex-shader" type="x-shader/x-vertex">
    // A basic flat vertex shader, hello world'esque.
    uniform mat4 projectionViewMatrix;
    attribute vec2 position;

    void main() {
      vec4 sizedPosition = vec4(position[0], position[1], 0.0, 1.0);
      gl_Position = projectionViewMatrix*sizedPosition;
    }
  </script>

  <script id="flat-fragment-shader" type="x-shader/x-fragment">
    // A basic flat fragment shader, hello world'esque.
    uniform highp vec4 surfaceColor;

    void main() {
      gl_FragColor = surfaceColor;
    }
  </script>

  <script id="texture-vertex-shader" type="x-shader/x-vertex">
    // A basic flat vertex shader, hello world'esque.
    uniform mat4 projectionViewMatrix;
    attribute vec2 position;
    attribute vec2 texCoord;

    varying vec2 texCoordVarying;

    void main() {
      texCoordVarying = texCoord;
      vec4 sizedPosition = vec4(position[0], position[1], 0.0, 1.0);
      gl_Position = projectionViewMatrix*sizedPosition;
    }
  </script>

  <script id="texture-fragment-shader" type="x-shader/x-fragment">
    // A basic flat fragment shader, hello world'esque.
    varying highp vec2 texCoordVarying;
    uniform sampler2D mainTexture;

    void main() {
      //gl_FragColor = vec4(texture2D(mainTexture, texCoordVarying));
      gl_FragColor = vec4(texture2D(mainTexture, texCoordVarying));
//      gl_FragColor = vec4(0.0, texCoordVarying[1], 0.0, 1.0);
    }
  </script>


</head>
<body>
  <div class="canvas-container">
    <canvas class="canvas-3d" width="700" height="700"></canvas>
    <canvas class="canvas-2d" width="256" height="256"></canvas>
  </div>
  <button class="simulate">Do click</button>

  <script src="../src/lib/bower_components/jquery/dist/jquery.js"></script>
  <script src="../src/lib/bower_components/lodash/dist/lodash.js"></script>
  <script src="../src/lib/bower_components/gl-matrix/dist/gl-matrix.js"></script>
  <script src="../src/lib/webgl-utils/webgl-utils.js"></script>
  <script src="../src/lib/bower_components/zebra/zebra.js"></script>
  <script src="../src/wr3d/scene.js"></script>
  <script src="../src/wr3d/dock.js"></script>
  <script src="../src/wr3d/rectangular-surface.js"></script>
  <script src="../src/wr3d/texturemap.js"></script>
  <script src="../src/wr3d/canvas.js"></script>

  <script>

    var canvasHtml = '../src/components/canvasTest/canvasTest.json';

    setTimeout(function() {
      var canvas = $('.canvas-3d');
      var scene = new Ngl.Scene();
      canvas.data('scene', scene);
      scene.initialize(canvas);

      var textureCanvas = new Ngl.Canvas('.canvas-2d', canvasHtml, 300, 200);
      textureCanvas.build();
      var texture = new Ngl.Texturemap(textureCanvas);

      var surface = new Ngl.RectangularSurface(0.05, 0.05, texture);
      scene.add(surface);

      var mouseMoveX = -1; mouseMoveY = -1, previousX = -1, previousY = -1;
      $(document).mousemove(function(event) {
        var offset = canvas.offset();
        mouseMoveX = event.pageX-offset.left;
        mouseMoveY = event.pageY-offset.top;
      });

      var renderCount = 1;

      function render() {
        requestAnimationFrame(render);

        if(renderCount % 2) {
          scene.render(mouseMoveX, mouseMoveY);
        } else {
//          if(previousX !== mouseMoveX || previousY !== mouseMoveY) {
            scene.getObjectUnderPixel(mouseMoveX, mouseMoveY);
//          }
          previousX = mouseMoveX;
          previousY = mouseMoveY;
        }
        renderCount++;
      }

      render();
    }, 1000);

  </script>

</body>
</html>