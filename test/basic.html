<!DOCTYPE html>
<html>
<head>
  <title>WhiteRabbit3D Basic Test</title>
  <link rel="stylesheet" href="../src/lib/bower_components/bootstrap/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="../src/appearance/css/whiterabbit3d.css"/>
  <link rel="-wr3d-stylesheet-3d" href="../src/components/canvas-test/canvas-test.css"/>
  <link rel="shortcut icon" href="images/wr3d.png" />
  <style>
    .canvas-container {
      width: 1000px;
      height: 500px;
      margin: 40px auto 0px auto;
    }

    .canvas-3d {
      width: 700px;
      height: 700px;
      display: inline-block;
      z-index: 10;
    }

    .html2canvas-container {
      xposition: absolute;
      xtop: -200px;
      xleft: 5px;
      height: 1500px;
      width: 1000px;
    }

    .html2canvas-test {
      width:1024px;
      height:128px;
      color: white;
      padding: 1px 1px;
    }

    .inner {
      border: gray solid 1px;
      width: 98%;
    }

    .html2canvas-test-2 {
      width:600px;
      height:128px;
      color: white;
      padding: 1px 1px;
    }

    .inner-2 {
      border: gray solid 1px;
      font-size: 14px;
      width: 94%;
    }

    .canvas-3d-container {
      z-index: 10;
      display: inline-block;
    }

    .control-container {
      border: #d3d3d3 solid 1px;
      margin-left: 10px;
      padding: 20px;
      vertical-align: top;
      display: inline-block;
    }

    .control-container>div {
      margin-top:20px;
    }

    .control-container>div:first-child {
      margin-top:0px;
    }

    .coordinate-container>div, .color-container>div {
      display: inline-block;
    }

    .song-title div {
      border-bottom: white 3px solid;
      border-top: white 2px solid;
      color: white;
      font-size: 40px;
    }



  </style>

  <script id="flat-vertex-shader" type="x-shader/x-vertex">
    // A basic flat vertex shader, hello world'esque.
    uniform mat4 projectionViewMatrix;
    attribute vec2 position;

    void main() {
      vec4 sizedPosition = vec4(position[0], position[1], 0.0, 1.0);
      gl_Position = projectionViewMatrix*sizedPosition;
    }
  </script>

  <script id="flat-fragment-shader" type="x-shader/x-fragment">
    // A basic flat fragment shader, hello world'esque.
    uniform highp vec4 surfaceColor;

    void main() {
      gl_FragColor = surfaceColor;
    }
  </script>

  <script id="texture-vertex-shader" type="x-shader/x-vertex">
    const int MAX_SURFACES = 4;
    struct surfaceData {
      mat4 floatData;
      mat4 transformBefore;
      mat4 transformAfter;
      ivec4 integerData;
    };
    uniform surfaceData surfaceDataArray[MAX_SURFACES];

    const float NXGR_PI = 3.141592653589;
    const float NXGR_E  = 2.718281828459;
    uniform mat4 projectionViewMatrix;
    uniform vec3 size;
    uniform vec2 textureScale;
    uniform float pixelSize;
    uniform ivec4 instructions;
    attribute vec3 position;
    attribute vec2 texCoord;

    varying vec2 texCoordVarying;
    varying highp float testValue;

    vec4 circularWarp(int dataIndex, vec4 posIn) {
      vec4 pos = surfaceDataArray[dataIndex].transformBefore*posIn;

      // surface data:
      //   0,0: outer radius - radius in pixels.
      float radiusOuter = surfaceDataArray[dataIndex].floatData[0][0];

      float radius = radiusOuter+pos.y/pixelSize;
      float xPixels = pos.x/pixelSize;

      float angle = -xPixels/radiusOuter+90.0/180.0*NXGR_PI;
      radius = radiusOuter*pow(NXGR_E, -(radiusOuter-radius)/radiusOuter);
      float x = radius*cos(angle)*pixelSize;
      float y = radius*sin(angle)*pixelSize;
      float z = pos[2]; //////////////////////+offsetAfterZ*pixelSize;

      return surfaceDataArray[dataIndex].transformAfter*vec4(x, y, z, 1.0);
    }

    void main() {
      testValue = 0.0;
      texCoordVarying.x = texCoord.x*textureScale.x;
      texCoordVarying.y = 1.0-(1.0-texCoord.y)*textureScale.y;

      vec4 sizedPosition = vec4(size[0]*position[0], size[1]*position[1], position[2], 1.0);

      for(int i=0; i<4; i++) {
        if(instructions[i] == 0) {
          break;
        } else if(instructions[i] == 2) {
          sizedPosition = circularWarp(i, sizedPosition);
        }
      }


      gl_Position = projectionViewMatrix*sizedPosition;
    }

  </script>

  <script id="texture-fragment-shader" type="x-shader/x-fragment">
    // A basic flat fragment shader, hello world'esque.
    varying highp vec2 texCoordVarying;
    uniform sampler2D mainTexture;
    varying highp float testValue;

    void main() {
      if(testValue != 0.0) {
        gl_FragColor = vec4(testValue, testValue, testValue, 1.0);
      } else {
        gl_FragColor = vec4(texture2D(mainTexture, texCoordVarying));
      }
    }
  </script>

  <script id="texture-color-select-fragment-shader" type="x-shader/x-fragment">
    uniform highp vec4 surfaceColor;

    void main() {
      gl_FragColor = surfaceColor;
    }
  </script>

  <script id="texture-texture-select-fragment-shader" type="x-shader/x-fragment">
    varying highp vec2 texCoordVarying;
    uniform sampler2D mainTexture;

    void main() {
      gl_FragColor = vec4(texture2D(mainTexture, texCoordVarying));
    }
  </script>


  <script id="selection-texture-builder-vertex-shader" type="x-shader/x-vertex">

    precision highp float;
    uniform float width;         // The width of the bitmap in pixels.
    attribute vec2 position;
    attribute vec2 increment;
    varying vec2 xyCoordinate;

    void main() {
      gl_Position = vec4(position[0], position[1], 0.0, 1.0);
      xyCoordinate = increment*width;
    }

  </script>

  <script id="selection-texture-builder-fragment-shader" type="x-shader/x-fragment">

    precision highp float;
    uniform float width;
    varying vec2 xyCoordinate;

    void main() {
      float l = (xyCoordinate.y-0.5)*width+(xyCoordinate.x-0.5);

      float r = floor(l*0.00001525878);          // divided by 256^2
      float g = floor((l-r*65536.0)*0.00390625); // divided by 256
      float b = floor(l-r*65536.0-g*256.0);

      gl_FragColor = vec4(r/255.0, g/255.0, b/255.0, 1.0);
    }

  </script>

</head>
<body>
  <div class="canvas-container">
    <div class="canvas-3d-container">
      <canvas class="canvas-3d" width="700" height="700"></canvas>
    </div>
    <div class="control-container">
      <div>
        <button class="show-canvas btn btn-primary">Canvas</button>
        <button class="show-color btn btn-secondary">Color</button>
        <button class="show-texture btn btn-secondary">Texture</button>
      </div>
      <div>
        <button class="simulate btn btn-primary">Do click</button>
      </div>
      <div class="coordinate-container">
        <div>Coordinate:</div>
        <div class="coord coord-x">X</div>
        <div class="coord coord-y">Y</div>
      </div>
      <div class="color-container">
        <div>Color:</div>
        <div class="color color-r"></div>
        <div class="color color-g"></div>
        <div class="color color-b"></div>
      </div>
    </div>

    <div class="html2canvas-container">
        <div class="html2canvas-test">
          <div class="inner">Outer canvas</div>
        </div>
        <div class="html2canvas-canvas"></div>

        <div class="html2canvas-test-2">
          <div class="inner-2">Outer canvas</div>
        </div>
        <div class="html2canvas-canvas-2"></div>
    </div>
  </div>

  <div class="container-3d-content">
    <div class="wr3d-host song-title-host">
      <div class="song-title">
        <div>Hi there</div>
      </div>
    </div>
  </div>

  <script src="../src/lib/bower_components/jquery/dist/jquery.js"></script>
  <script src="../src/lib/bower_components/lodash/dist/lodash.js"></script>
  <script src="../src/lib/bower_components/angular/angular.js"></script>
  <script src="../src/lib/bower_components/angular-route/angular-route.js"></script>
  <script src="../src/lib/bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
  <script src="../src/lib/bower_components/q/q.js"></script>
  <script src="../src/lib/random/random-0.26-debug.js"></script>
  <script src="../src/lib/bower_components/gl-matrix/dist/gl-matrix.js"></script>
  <script src="../src/lib/bower_components/cssjson/cssjson.js"></script>
  <script src="../src/lib/html2canvas/html2canvas.js"></script>
  <script src="../src/lib/webgl-utils/webgl-utils.js"></script>
  <script src="../src/lib/zebra/zebra.js"></script>
  <script src="../src/wr3d/scene.js"></script>
  <script src="../src/wr3d/camera.js"></script>
  <script src="../src/wr3d/dock.js"></script>
  <script src="../src/wr3d/wr-dock.js"></script>
  <script src="../src/wr3d/wr-panel.js"></script>
  <script src="../src/wr3d/rectangular-surface.js"></script>
  <script src="../src/wr3d/texturemap.js"></script>
  <script src="../src/wr3d/canvas.js"></script>
  <script src="../src/wr3d/selection-renderer.js"></script>
  <script src="../src/wr3d/surfaces/circular.js"></script>

  <script src="../src/components/canvas-test/canvas-test.js"></script>

  <script>

    setTimeout(function() {
      var canvas = $('.canvas-3d');
      var scene = new Ngl.Scene();
      canvas.data('scene', scene);
      scene.initialize(canvas);

      scene.add(new Ngl.WrPanel({
        name:         'song-title',
        host:         '.wr3d-host.song-title-host',
        position3d:   'translate(0px, 0px, 0px)',
        display3d:    'surface',
        scaling3d:    'screen',
        surfaces3d:   [{ "type": "circular", "radiusOuter": "300px", "angle": "full" }]
      }));
/*
      var panel = new Ngl.WrPanel({
        name:         'Main',
        sourceElement:'.html2canvas-test-2',
        radius3d:     '100',
        position3d:   'translate(0px, 0px, 0px)',
        size3d:       '(400px, 75px)',
        canvasUrl:    '../src/components/circular-test/circular-test.json',
        controller:   '../src/components/circular-test/circular-test.js',
        display3d:    'surface',
        scaling3d:    'screen',
        magnification3d: 1.0,
        surfaceProperties3d: '[{ "type": "circular", "radius": "300px" }]',
        surface3d:    'curved',
        origin3d:     'center'
      });
      scene.add(panel);
*/
      var mouseMoveX = -1; mouseMoveY = -1, previousX = -1, previousY = -1;
      $(document).mousemove(function(event) {
        var offset = canvas.offset();
        mouseMoveX = event.pageX-offset.left;
        mouseMoveY = event.pageY-offset.top;
      });

      var renderCount = 1;

      function render() {
        requestAnimationFrame(render);

        if(renderCount % 2) {
          scene.render(mouseMoveX, mouseMoveY);
        } else {
//          if(previousX !== mouseMoveX || previousY !== mouseMoveY) {
//            scene.getObjectUnderPixel(mouseMoveX, mouseMoveY);
//          }
          previousX = mouseMoveX;
          previousY = mouseMoveY;
        }
        renderCount++;
      }

      render();
    }, 1000);

    $('.show-canvas').on('click', function() {
      $('.canvas-3d').data('wr3dScene').setRenderMode('canvas');
    });
    $('.show-color').on('click', function() {
      $('.canvas-3d').data('wr3dScene').setRenderMode('color');
    });
    $('.show-texture').on('click', function() {
      $('.canvas-3d').data('wr3dScene').setRenderMode('texture');
    });

  </script>

</body>
</html>